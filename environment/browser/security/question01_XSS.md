# 谈谈XSS攻击

XSS攻击的全名是Cross-Site Scripting，跨站脚本攻击。是一种代码注入的攻击。

**攻击者通过向目标网站注入恶意脚本，使其在浏览器中运行，利用这些恶意的代码，获取用户的私密信息，如Cookie，SessionID等等，从而危害用户的数据安全。**

说白了就是攻击者想方设法让目标网站能够执行自己提供的脚本代码。一旦执行成功，攻击者就掌握了主动权，就可以想干啥就干啥

## 1. XSS攻击的类型

根据攻击者的来源，可以将XSS攻击分成三种：

1. 存储型
2. 反射型
3. DOM型

### 1.1 存储型

存储型XSS的攻击步骤：

1. 攻击者将恶意代码**提交到目标网站的数据库**中
2. 用户打开目标网站时，网站服务端将恶意代码从数据库取出，**拼接在 HTML 中返回给浏览器**
3. 用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作

这种攻击的特点是**很持久**，因为是攻击脚本存储在数据库中的，每次访问的时候都会被攻击。

**这种攻击常见于带有用户保存数据的网站功能，如论坛发帖、商品评论、用户私信等。**



### 1.2 反射型

反射型XSS的攻击步骤：

1. 攻击者**构造出特殊的 URL**，其中包含恶意代码。
2. 用户打开带有恶意代码的 URL 时，**网站服务端将恶意代码从 URL 中取出，拼接在 HTML 中返回给浏览器**
3. 用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

**反射型 XSS 漏洞常见于通过 URL 传递参数的功能，如网站搜索、跳转等**，攻击者往往需要诱导用户点击攻击的连接，比如发送邮件，内部包含构造好的攻击跳转链接

反射型和存储型之间的差异：

- 存储型XSS是将攻击脚本存在数据库中
- 反射型XSS是将攻击脚本存在URL中



### 1.3 DOM型

DOM型攻击的步骤：

1. 攻击者构造特殊的URL，其中包含恶意代码
2. 用户打开带有恶意代码的 URL
3. 用户浏览器接收到响应后解析执行，**前端 JavaScript 取出 URL 中的恶意代码并执行**
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作

DOM型XSS攻击和前面两种攻击的区别在于：**DOM型攻击中，获取恶意代码的操作是在前端完成的，与服务端无关，属于前端自身的安全漏洞；但是前面两种攻击中是有服务端获取获取恶意代码的，属于服务端的安全漏洞。**



## 2. XSS攻击的预防手段

**从前面的分析中可以看出，XSS攻击主要有两个要素**：

1. 攻击者提交恶意的代码
2. 浏览器执行恶意的代码

**所以在防范XSS攻击上有两种思路**：

1. 防止攻击者提交恶意的代码
2. 防止浏览器执行恶意的代码

### 2.1 防止攻击者提交恶意的代码

防止提交恶意代码的措施有：

1. 输入内容过滤
2. 输出内容转义

#### 2.1.1 输入内容过滤

记住一点：**不要相信任何输入的内容**

输入过滤是指在前端对输入的内容做一些过滤，比如内容和格式或者长度等等。还可以对一些特殊的字符进行过滤，防止XSS攻击。

但是**这种在前端设置的过滤手段是不可靠的，攻击者很容易就可以绕过前端过滤**，所以这只是一种配合后端的手段。真正的项目中，后端还是要进行检查和过滤的。

#### 2.1.2 输出内容转义

在项目中，有很多的服务端输出的内容都会拼接到html中，所以对于输出的内容是需要进行转义的。否则可能会出现`<script></script>`这样的恶意代码拼接到html中

一般需要转义的字符：

| 特殊字符 | 转义字符 |
| -------- | -------- |
| &        | &amp ;   |
| <        | &lt ;    |
| >        | &gt ;    |
| "        | &quot ;  |
| '        | &#x27 ;  |
| /        | &#x2F ;  |

真正需要转义的字符有很多，这里只是列举除了一些常用的字符



### 2.2 防止浏览器执行恶意代码

这个阶段的防护是在**恶意代码已经注入**之后的防护

1. 内容安全策略（CSP）

2. 使用HTTP-only

3. 验证码

#### 2.2.1 CSP

**CSP的全称是Content-Security-Policy，实际是一种报名单的制度。开发者明确告诉客户端，哪些站点的资源可以加载和执行，等同于提供了一个白名单。**

启用CSP的方法：

1. 在响应头中设置`Content-Security-Policy`字段

2. 通过设置网页的meta标签

   ```html
   <meta http-equiv="Content-Security-Policy" content="script-src 'self'; object-src 'none'; style-src cdn.example.org third-party.org; child-src https:">
   ```

严格的CSP规则在XSS攻击中能够起到很好的作用：

1. **禁止加载外域代码**，防止复杂的攻击逻辑
2. **禁止外域提交**，网站被攻击后，用户的数据不会泄露到外域
3. **禁止内联脚本执行**（规则较严格，目前发现 GitHub 使用）

#### 2.2.2 HTTP-only

在设置Cookie的时候，加上HttpOnly属性，可以防止js代码中获取Cookie

#### 2.2.3 验证码

防止恶意代码冒充用户提交表单



## 3. 参考文章

1. [前端安全系列（一）：如何防止XSS攻击？](https://juejin.im/post/5bad9140e51d450e935c6d64#heading-23)

2. [Web安全系列（四）：XSS 的防御](https://juejin.im/post/5bac9e21f265da0afe62ec1b#heading-7)

3. [Content Security Policy 入门教程](http://www.ruanyifeng.com/blog/2016/09/csp.html)

