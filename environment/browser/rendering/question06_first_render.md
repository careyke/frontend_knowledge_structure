# 详细分析页面首次渲染和JS、CSS资源的关系

页面首次渲染时和JS、CSS资源之间的关系是一个困惑笔者很久的问题。看过了很多的文章，但是感觉分析得都比较粗略，其中的很多细节还是没有讲清楚。在这篇文章中，笔者会结合一些具体的实例来详细的解读其中的关系。



## 1. 页面渲染的完整流程

在分析页面渲染和静态资源之间的关系之前，我们先要来分析**一个HTML文件从下载到最终内容呈现到页面上**这其中经历了哪些过程。

可以理解为是**一个完整的渲染周期**：

1. 渲染进程将`HTML`内容转化成能够读懂的**`DOM 树`**结构（**Parse HTML**）
2. 渲染引擎将`CSS`样式表转化成浏览器可以理解的**`StyleSheets`**，计算出`DOM`节点的样式（**Parse Stylesheet 、Recalculate Style**）

3. 创建**布局树**，并计算布局信息（**Layout**）
4. 对布局树进行分层，并生成**分层树**（**Update Layer Tree**）
5. 为每个图层生成**绘制列表**，并将其提交给**合成线程**（**Paint**）
6. 合成线程将图层分成**图块**，并在**光栅化线程池**中将图块转化成**位图**（**Composite Layers**）
7. 合成线程发送绘制图块的命令 **`DrawQuad`** 给浏览器进程
8. 浏览器进程根据 `DrawQuad` 消息**生成页面**，并显示在显示器上

上面渲染的步骤中，后面括号中标注的是**每个步骤对应的`Performance`中的任务**。其中6、7、8三步可以理解为对应的任务都是`Composite Layers`。

> 这里针对`Recalculate Style`需要说明一下：
>
> 这个任务主要做的工作是**从`StyleSheets`中计算每个`DOM`节点的样式信息**，这个任务执行的时机有以下几种：
>
> 1. 发生在`Parse HTML`阶段。比如`CSS和JS`文件都在head中引入，此时`StyleSheets`已经生成，可以再创建DOM时计算对应的样式
> 2. 发生在`Parse Stylesheet`阶段。比如动态添加一个CSS文件
> 3. 单独执行。比如动态修改某个元素的样式
>
> 后面两个例子笔者还没有验证，主要是想说**这个任务是一个灵活的任务，可以和其他任务合并执行。**

> 页面渲染流程的详细分析可以看[这里](https://time.geekbang.org/column/article/118205)，李兵老师在极客时间开的课程，推荐！



上面流程中可以看到，**只有`Composite Layers`任务执行完成之后，对应的内容才会显示到浏览器中**。后面分析中我们可以通过这个任务来判断页面首次渲染的时机。



## 2. 页面渲染和静态资源之间的关系

